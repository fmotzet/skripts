#!/usr/bin/env python3
"""
Reads data from a .env file in the same dir, requeires, your.atlassian.net domain, your email, your token.
Atlassian Group Export Script
Fetches all groups from Atlassian (Jira/Confluence) and their members, exports to CSV and JSON.
"""

import requests
import json
import csv
import os
from datetime import datetime
from typing import List, Dict, Optional
from dotenv import load_dotenv


class AtlassianGroupExporter:
    def __init__(self, base_url: str, email: str, api_token: str):
        """
        Initialize the Atlassian Group Exporter.
        
        Args:
            base_url: Your Atlassian instance URL (e.g., https://your-domain.atlassian.net)
            email: Your admin email address
            api_token: Your Atlassian API token
        """
        self.base_url = base_url.rstrip('/')
        self.auth = (email, api_token)
        self.headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
        
    def get_all_groups(self) -> List[Dict]:
        """
        Fetch all groups from Atlassian.
        Uses pagination to retrieve all groups.
        
        Returns:
            List of group dictionaries
        """
        all_groups = []
        start_at = 0
        max_results = 50
        
        print("Fetching groups from Atlassian...")
        
        while True:
            url = f"{self.base_url}/rest/api/3/group/bulk"
            params = {
                'startAt': start_at,
                'maxResults': max_results
            }
            
            try:
                response = requests.get(
                    url,
                    auth=self.auth,
                    headers=self.headers,
                    params=params,
                    timeout=30
                )
                response.raise_for_status()
                
                data = response.json()
                groups = data.get('values', [])
                
                if not groups:
                    break
                
                all_groups.extend(groups)
                print(f"Retrieved {len(all_groups)} groups so far...")
                
                # Check if we've retrieved all groups
                if data.get('isLast', True):
                    break
                    
                start_at += max_results
                
            except requests.exceptions.RequestException as e:
                print(f"Error fetching groups: {e}")
                if hasattr(e, 'response') and e.response is not None:
                    print(f"Response: {e.response.text}")
                raise
        
        print(f"Total groups retrieved: {len(all_groups)}")
        return all_groups
    
    def get_group_members(self, group_id: str, group_name: str) -> List[Dict]:
        """
        Fetch all members of a specific group.
        
        Args:
            group_id: The group ID
            group_name: The group name (for fallback)
            
        Returns:
            List of member dictionaries
        """
        all_members = []
        start_at = 0
        max_results = 50
        
        while True:
            url = f"{self.base_url}/rest/api/3/group/member"
            params = {
                'groupId': group_id,
                'startAt': start_at,
                'maxResults': max_results
            }
            
            try:
                response = requests.get(
                    url,
                    auth=self.auth,
                    headers=self.headers,
                    params=params,
                    timeout=30
                )
                response.raise_for_status()
                
                data = response.json()
                members = data.get('values', [])
                
                if not members:
                    break
                
                all_members.extend(members)
                
                # Check if we've retrieved all members
                if data.get('isLast', True):
                    break
                    
                start_at += max_results
                
            except requests.exceptions.RequestException as e:
                print(f"Warning: Could not fetch members for group '{group_name}': {e}")
                break
        
        return all_members
    
    def get_groups_with_members(self) -> List[Dict]:
        """
        Fetch all groups and their members.
        
        Returns:
            List of dictionaries containing group info and members
        """
        groups = self.get_all_groups()
        groups_data = []
        
        print("\nFetching members for each group...")
        for idx, group in enumerate(groups, 1):
            group_id = group.get('groupId', '')
            group_name = group.get('name', '')
            
            print(f"[{idx}/{len(groups)}] Processing group: {group_name}")
            
            members = self.get_group_members(group_id, group_name)
            
            # Create a record for each member in the group
            if members:
                for member in members:
                    group_member_data = {
                        'group_id': group_id,
                        'group_name': group_name,
                        'member_account_id': member.get('accountId', ''),
                        'member_email': member.get('emailAddress', member.get('name', '')),
                        'member_display_name': member.get('displayName', ''),
                        'member_active': member.get('active', False),
                        'member_account_type': member.get('accountType', '')
                    }
                    groups_data.append(group_member_data)
            else:
                # Include groups with no members
                group_member_data = {
                    'group_id': group_id,
                    'group_name': group_name,
                    'member_account_id': '',
                    'member_email': '',
                    'member_display_name': '',
                    'member_active': '',
                    'member_account_type': ''
                }
                groups_data.append(group_member_data)
        
        print(f"\nTotal group-member records: {len(groups_data)}")
        return groups_data
    
    def export_to_csv(self, groups_data: List[Dict], filename: Optional[str] = None) -> str:
        """
        Export groups and members to CSV file.
        
        Args:
            groups_data: List of group-member dictionaries
            filename: Optional custom filename
            
        Returns:
            Path to the created CSV file
        """
        if filename is None:
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"atlassian_groups_{timestamp}.csv"
        
        with open(filename, 'w', newline='', encoding='utf-8') as csvfile:
            if groups_data:
                fieldnames = [
                    'group_id', 'group_name', 
                    'member_account_id', 'member_email', 'member_display_name',
                    'member_active', 'member_account_type'
                ]
                writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
                
                writer.writeheader()
                writer.writerows(groups_data)
        
        print(f"CSV export completed: {filename}")
        return filename
    
    def export_to_json(self, groups_data: List[Dict], filename: Optional[str] = None) -> str:
        """
        Export groups and members to JSON file.
        
        Args:
            groups_data: List of group-member dictionaries
            filename: Optional custom filename
            
        Returns:
            Path to the created JSON file
        """
        if filename is None:
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"atlassian_groups_{timestamp}.json"
        
        with open(filename, 'w', encoding='utf-8') as jsonfile:
            json.dump(groups_data, jsonfile, indent=2, ensure_ascii=False)
        
        print(f"JSON export completed: {filename}")
        return filename


def main():
    """Main execution function."""
    # Load environment variables from .env file
    load_dotenv()
    
    # Load configuration from environment variables
    base_url = os.environ.get('ATLASSIAN_URL')
    email = os.environ.get('ATLASSIAN_EMAIL')
    api_token = os.environ.get('ATLASSIAN_API_TOKEN')
    
    # Check if credentials are provided
    if not all([base_url, email, api_token]):
        print("ERROR: Missing required credentials!")
        print("\nPlease set the following environment variables:")
        print("  - ATLASSIAN_URL: Your Atlassian instance URL (e.g., https://your-domain.atlassian.net)")
        print("  - ATLASSIAN_EMAIL: Your admin email address")
        print("  - ATLASSIAN_API_TOKEN: Your Atlassian API token")
        print("\nAlternatively, create a .env file or modify this script directly.")
        return
    
    try:
        # Initialize exporter
        exporter = AtlassianGroupExporter(base_url, email, api_token)
        
        # Fetch all groups with members
        groups_data = exporter.get_groups_with_members()
        
        if not groups_data:
            print("No groups found!")
            return
        
        # Export to both CSV and JSON
        csv_file = exporter.export_to_csv(groups_data)
        json_file = exporter.export_to_json(groups_data)
        
        print(f"\nâœ“ Successfully exported groups!")
        print(f"  CSV: {csv_file}")
        print(f"  JSON: {json_file}")
        
    except Exception as e:
        print(f"\nERROR: {e}")
        import traceback
        traceback.print_exc()
        return


if __name__ == "__main__":
    main()
